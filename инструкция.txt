sudo apt update && sudo apt upgrade -y
sudo apt install -y git python3-pip snapd python3.12-venv

# Устанавливаем Firefox и Geckodriver
sudo snap install firefox
sudo apt install -y firefox-geckodriver

# Создаем директорию проекта, если ещё не создана
sudo mkdir -p /ai-moder

# Создаем виртуальное окружение в папке /ai-moder
python3.12 -m venv /ai-moder/venv

# Всегда активируйте venv перед установкой библиотек!
source /ai-moder/venv/bin/activate

# Скачиваем последнюю версию Geckodriver и кидаем в venv/bin/
GECKO_VERSION=$(curl -s https://api.github.com/repos/mozilla/geckodriver/releases/latest | grep '"tag_name":' | cut -d '"' -f 4)
wget https://github.com/mozilla/geckodriver/releases/download/$GECKO_VERSION/geckodriver-$GECKO_VERSION-linux64.tar.gz
tar -xzf geckodriver-$GECKO_VERSION-linux64.tar.gz
mv geckodriver /ai-moder/venv/bin/
rm geckodriver-$GECKO_VERSION-linux64.tar.gz

# Устанавливаем все Python-библиотеки через pip внутри venv
pip install mss google-generativeai PyTelegramBotAPI deep-translator selenium opencv-python pandas pillow aiohttp numpy

# Настройка bare-репозитория для автоматического деплоя
sudo mkdir -p /ai-moder/server.git
cd /ai-moder/server.git
git init --bare

sudo tee hooks/post-receive > /dev/null << 'EOF'
git --work-tree=/ai-moder --git-dir=/ai-moder/server.git checkout -f main
EOF

sudo chmod +x hooks/post-receive

# Создаем systemd-сервис для автозапуска бота, обязательно используя интерпретатор из venv!
sudo tee /etc/systemd/system/aimoder.service > /dev/null << 'EOF'
[Unit]
Description=AI Moderation Bot
After=network.target

[Service]
ExecStart=/ai-moder/venv/bin/python /ai-moder/bot_test.py
WorkingDirectory=/ai-moder
Restart=always

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable aimoder
sudo systemctl start aimoder
